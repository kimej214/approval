<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.approval.repository.ApprovalMapper">

    <!-- ✅ 레벨별 조회 (사원 전용) -->
    <select id="findApprovalsPagedByRole" parameterType="map" resultType="com.project.approval.dto.ApprovalListDTO">
        SELECT
        a.num AS num,
        e1.emp_name AS writerId,
        a.title AS title,
        a.content AS content,
        a.reg_date AS regDate,
        a.appr_date AS apprDate,
        e2.emp_name AS approverId,
        s.status_name AS statusCode
        FROM approval_list a
        LEFT JOIN approval_emp e1 ON a.writer_id = e1.user_id
        LEFT JOIN approval_emp e2 ON a.approver_id = e2.user_id
        LEFT JOIN approval_status s ON a.status_code = s.status_code
        WHERE a.status_code != 'TMP'
        AND (a.writer_id = #{userId} OR a.approver_id = #{userId})
        ORDER BY a.num DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- ✅ 레벨별 카운트 -->
    <select id="countApprovalsByRole" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM approval_list
        WHERE status_code != 'TMP'
        AND (writer_id = #{userId} OR approver_id = #{userId})
    </select>

    <!-- ✅ 전체 조회 (관리자 / 상위직급) -->
    <select id="findApprovalsPaged" parameterType="map" resultType="com.project.approval.dto.ApprovalListDTO">
        SELECT
        a.num AS num,
        e1.emp_name AS writerId,
        a.title AS title,
        a.content AS content,
        a.reg_date AS regDate,
        a.appr_date AS apprDate,
        e2.emp_name AS approverId,
        s.status_name AS statusCode
        FROM approval_list a
        LEFT JOIN approval_emp e1 ON a.writer_id = e1.user_id
        LEFT JOIN approval_emp e2 ON a.approver_id = e2.user_id
        LEFT JOIN approval_status s ON a.status_code = s.status_code
        WHERE a.status_code != 'TMP'
        ORDER BY a.num DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- ✅ 단일 결재 상세 조회 -->
    <select id="findApprovalByNum"
            parameterType="long"
            resultType="com.project.approval.dto.ApprovalListDTO">
        SELECT
        a.num AS num,
        a.writer_id AS writerId,
        a.title AS title,
        a.content AS content,
        a.reg_date AS regDate,
        a.appr_date AS apprDate,
        a.approver_id AS approverId,
        a.status_code AS statusCode
        FROM approval_list a
        WHERE a.num = #{num}
    </select>

    <!-- ✅ 작성자의 임시저장 글 1건 조회 -->
    <select id="findDraftByWriter" resultType="com.project.approval.dto.ApprovalListDTO">
        SELECT
        num, writer_id AS writerId, title, content, reg_date AS regDate, status_code AS statusCode
        FROM approval_list
        WHERE writer_id = #{writerId}
        AND status_code = 'TMP'
        ORDER BY reg_date DESC
        LIMIT 1
    </select>

    <!-- ✅ 전체 개수 -->
    <select id="countApprovals" resultType="int">
        SELECT COUNT(*) FROM approval_list WHERE status_code != 'TMP'
    </select>

    <!-- ✅ 현재 최대 글번호 -->
    <select id="findMaxNum" resultType="long">
        SELECT MAX(num) FROM approval_list
    </select>

    <!-- ✅ 신규 결재 등록 (임시저장 or 결재요청) -->
    <insert id="insertApproval"
            parameterType="com.project.approval.dto.ApprovalListDTO"
            useGeneratedKeys="true"
            keyProperty="num">
        INSERT INTO approval_list
        (writer_id, title, content, reg_date, status_code)
        VALUES
        (#{writerId}, #{title}, #{content}, NOW(), #{statusCode})
    </insert>

    <!-- ✅ 상태 변경 -->
    <update id="updateStatus">
        UPDATE approval_list
        SET status_code = #{statusCode}
        WHERE num = #{num}
    </update>

</mapper>